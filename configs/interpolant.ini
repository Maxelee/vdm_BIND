[TRAINING]
# ==============================================================================
# Interpolant / Flow Matching Configuration
# ==============================================================================
# 
# This config uses stochastic interpolants (flow matching) for the DMO -> Hydro
# mapping, following the approach in BaryonBridge (Sadr et al.).
#
# Key differences from VDM/DDPM:
#   - Learns velocity field v(t, x) instead of score/noise
#   - Simple MSE loss on velocity prediction
#   - No noise schedule to tune
#   - Deterministic ODE sampling
#   - Often faster convergence and fewer sampling steps needed
# ==============================================================================

seed = 8
dataset = IllustrisTNG
data_root = /mnt/home/mlee1/ceph/train_data_rotated2_128_cpu/train/
field = gas
boxsize = 6.25

# ==============================================================================
# TRAINING HYPERPARAMETERS
# ==============================================================================
# Flow matching is often more stable than diffusion, allowing larger batch sizes
# and faster convergence.
#
# Effective batch size = batch_size * accumulate_grad_batches * num_gpus
# With batch_size=16, accumulate=4, 4 GPUs: effective=256

batch_size = 16
accumulate_grad_batches = 4
num_workers = 8
cropsize = 128
max_epochs = 250

# ==============================================================================
# LEARNING RATE
# ==============================================================================

learning_rate = 1e-4
weight_decay = 1e-5
lr_scheduler = cosine

# ==============================================================================
# ARCHITECTURE
# ==============================================================================
# Uses the same UNet architecture as VDM, but for velocity prediction
# instead of noise prediction.

embedding_dim = 256
n_blocks = 32
norm_groups = 8
n_attention_heads = 8

# Conditioning channels
# 1 for DM input, 3 for large-scale context (12.5, 25, 50 Mpc/h)
conditioning_channels = 1
large_scale_channels = 3

# Fourier features and attention
use_fourier_features = True
fourier_legacy = False
add_attention = True

# ==============================================================================
# INTERPOLANT-SPECIFIC PARAMETERS
# ==============================================================================

# x0_mode: How to initialize the source distribution
#   - 'zeros': Start from zeros (recommended, simpler)
#   - 'noise': Start from Gaussian noise (like diffusion)
#   - 'dm_copy': Start from DM condition copied to all channels
x0_mode = zeros

# Stochastic interpolant: Add noise during interpolation
# This can improve diversity but may slow convergence
use_stochastic_interpolant = False
sigma = 0.0

# Number of sampling steps for ODE integration
# Flow matching typically needs fewer steps than diffusion (20-50 vs 250-1000)
n_sampling_steps = 50

# ==============================================================================
# EMA (Exponential Moving Average)
# ==============================================================================
# EMA helps stabilize sampling quality

enable_ema = True
ema_decay = 0.9999
ema_update_after_step = 0
ema_update_every = 1

# ==============================================================================
# EARLY STOPPING
# ==============================================================================

enable_early_stopping = True
early_stopping_patience = 300

# ==============================================================================
# GRADIENT MONITORING
# ==============================================================================

enable_gradient_monitoring = True
gradient_log_frequency = 100

# ==============================================================================
# LOGGING
# ==============================================================================

tb_logs = /mnt/home/mlee1/ceph/tb_logs/
model_name = interpolant_3ch
version = 0
