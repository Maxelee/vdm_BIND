[TRAINING]
# ==============================================================================
# CleanVDM - REGULARIZED Configuration with BIJECTIVE Dataset
# ==============================================================================
# 
# Same as clean_vdm_regularized.ini but using the bijective training dataset:
#   /mnt/home/mlee1/ceph/train_data_rotated2_bijective_128_cpu/
#
# This config addresses overfitting issues by:
#   1. DISABLING EMA (was causing checkpoint issues)
#   2. ADDING DROPOUT (0.1) for regularization
#   3. INCREASING WEIGHT DECAY (1e-4 instead of default 1e-5)
#   4. HIGHER DATA NOISE for augmentation
#   5. ENABLING EARLY STOPPING based on validation loss
#   6. Using 32-bit precision for stability
#
# The learned_nn noise schedule is kept for flexibility.
# ==============================================================================

seed = 8
dataset = IllustrisTNG
data_root = /mnt/home/mlee1/ceph/train_data_rotated2_bijective_128_cpu/train/
field = gas
boxsize = 6.25 

# ==============================================================================
# TRAINING HYPERPARAMETERS
# ==============================================================================

batch_size = 128
num_workers = 40
cropsize = 128
max_epochs = 250

# ==============================================================================
# LEARNING RATE
# ==============================================================================

learning_rate = 5e-5 
lr_scheduler = cosine_warmup 

# INCREASED WEIGHT DECAY for regularization (was default 1e-5)
weight_decay = 1e-4

# ==============================================================================
# VDM NOISE SCHEDULE
# ==============================================================================

# Keep learned_nn as requested
noise_schedule = learned_nn  
gamma_min = -13.3
gamma_max = 13.0

# ==============================================================================
# DATA AUGMENTATION - STRONGER
# ==============================================================================

# Increased data noise for better regularization
data_noise = 1e-3, 1e-3, 1e-3
antithetic_time_sampling = True

# ==============================================================================
# ARCHITECTURE - DEEP AND WIDE
# ==============================================================================

n_blocks = 5
embedding_dim = 96
norm_groups = 8
n_attention_heads = 8 
large_scale_channels = 3

# ADDED: Dropout for regularization
dropout = 0.1

# ==============================================================================
# CROSS-ATTENTION: DISABLED
# ==============================================================================

use_cross_attention = False

# ==============================================================================
# SELF-ATTENTION: ENABLED
# ==============================================================================

add_attention = True

# ==============================================================================
# FEATURE ENGINEERING
# ==============================================================================

use_fourier_features = True
legacy_fourier = False

# ==============================================================================
# LOSS CONFIGURATION - AGGRESSIVE STELLAR FOCUS
# ==============================================================================

lambdas = 1.0, 1.0, 1.0
channel_weights = 1.0, 1.0, 3.0

# Focal loss disabled (can enable if needed)
use_focal_loss = False
focal_gamma = 3.0  

# ==============================================================================
# PARAMETER CONDITIONING
# ==============================================================================

use_param_prediction = True
param_prediction_weight = 0.01
param_norm_path = /mnt/home/mlee1/Sims/IllustrisTNG_extras/L50n512/SB35/SB35_param_minmax.csv

# ==============================================================================
# STELLAR NORMALIZATION
# ==============================================================================

quantile_path = /mnt/home/mlee1/vdm_BIND/data/quantile_normalizer_stellar.pkl
use_quantile_normalization = True

# ==============================================================================
# MONITORING
# ==============================================================================

validation_plot_frequency = 500

# ENABLED: Early stopping to prevent overfitting
enable_early_stopping = True
early_stopping_patience = 20
early_stopping_min_delta = 0.001

enable_fid_monitoring = False
enable_gradient_monitoring = True
gradient_log_frequency = 50

# ==============================================================================
# EMA - DISABLED
# ==============================================================================
# Disabled due to checkpoint saving issues causing mismatch between
# validation (with EMA) and inference (without EMA)

enable_ema = False

# ==============================================================================
# TRAINING DATA
# ==============================================================================

limit_train_samples = None
limit_val_samples = None
limit_train_batches = 1.0

# ==============================================================================
# LOGGING
# ==============================================================================

model_name = clean_vdm_regularized_bijective
tb_logs = /mnt/home/mlee1/ceph/tb_logs3
version = 0

# ==============================================================================
# PRECISION - Full 32-bit for stability
# ==============================================================================

precision = 32
compile_model = False
