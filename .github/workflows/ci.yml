name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install linting tools
        run: |
          pip install flake8 black isort
      
      - name: Check formatting with black
        run: |
          black --check --diff vdm/ bind/ tests/ || echo "::warning::Code formatting issues found"
      
      - name: Check imports with isort
        run: |
          isort --check-only --diff vdm/ bind/ tests/ || echo "::warning::Import sorting issues found"
      
      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 vdm/ bind/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 vdm/ bind/ --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Install package
        run: |
          pip install -e .
      
      - name: Run tests
        run: |
          pytest tests/ -v --tb=short \
            --ignore=tests/test_integration.py \
            --ignore=tests/test_data_generation.py \
            -k "not test_load_single_sample"
        env:
          VDM_BIND_ROOT: ${{ github.workspace }}
      
      - name: Run tests with coverage
        if: matrix.python-version == '3.10'
        run: |
          pytest tests/ --cov=vdm --cov=bind --cov-report=xml \
            --ignore=tests/test_integration.py \
            --ignore=tests/test_data_generation.py \
            -k "not test_load_single_sample"
        env:
          VDM_BIND_ROOT: ${{ github.workspace }}
      
      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.10'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  test-gpu:
    runs-on: ubuntu-latest
    # Only run GPU tests on main branch to save resources
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest
      
      - name: Install package
        run: |
          pip install -e .
      
      - name: Run CPU-only integration tests
        run: |
          pytest tests/test_integration.py -v -k "cpu or CPU" --tb=short || true
        env:
          VDM_BIND_ROOT: ${{ github.workspace }}
          CUDA_VISIBLE_DEVICES: ""

  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Check documentation
        run: |
          # Verify README links are valid
          pip install markdown-link-check || true
          # Check that all config files mentioned exist
          echo "Checking that referenced config files exist..."
          for config in configs/*.ini; do
            echo "✓ $config"
          done

  validate-configs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install configparser
      
      - name: Validate config files
        run: |
          python -c "
          import configparser
          from pathlib import Path
          
          configs = list(Path('configs').glob('*.ini'))
          print(f'Found {len(configs)} config files')
          
          for config_path in configs:
              print(f'Validating {config_path}...')
              config = configparser.ConfigParser()
              config.read(config_path)
              
              # Check required section exists
              assert 'TRAINING' in config.sections(), f'{config_path} missing [TRAINING] section'
              
              # Check required keys
              params = dict(config['TRAINING'])
              required = ['seed', 'batch_size']
              for key in required:
                  assert key in params, f'{config_path} missing required key: {key}'
              
              print(f'  ✓ {config_path} is valid')
          
          print('All configs validated successfully!')
          "
